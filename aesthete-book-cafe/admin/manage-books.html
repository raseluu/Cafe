<div class="card-header">
    <h3>Books Management</h3>
    <div>
        <button class="btn btn-outline" onclick="exportBooks()">
            <i class="fas fa-download"></i> Export
        </button>
        <button class="btn btn-primary" onclick="showAddBookForm()">
            <i class="fas fa-book-medical"></i> Add Book
        </button>
    </div>
</div>

<div class="admin-alert">
    <div>
        <i class="fas fa-info-circle"></i>
        <span>Manage the book collection, pricing, and featured books.</span>
    </div>
    <button class="btn btn-sm" onclick="refreshBooks()">
        <i class="fas fa-sync-alt"></i>
    </button>
</div>

<!-- Add Book Form (Initially Hidden) -->
<div id="addBookForm" style="display: none; background: white; padding: 30px; border-radius: 8px; margin-bottom: 30px;">
    <h4 style="margin-bottom: 25px;">Add New Book</h4>
    
    <form id="bookForm">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label>Book Title *</label>
                <input type="text" name="title" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div class="form-group">
                <label>Author *</label>
                <input type="text" name="author" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label>Price ($) *</label>
                <input type="number" name="price" min="0" step="0.01" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div class="form-group">
                <label>Category</label>
                <select name="category" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Select Category</option>
                    <option value="Fiction">Fiction</option>
                    <option value="Non-Fiction">Non-Fiction</option>
                    <option value="Poetry">Poetry</option>
                    <option value="Philosophy">Philosophy</option>
                    <option value="Art">Art</option>
                    <option value="Biography">Biography</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>Description</label>
            <textarea name="description" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="form-group">
                <label>Image URL</label>
                <input type="url" name="image_url" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" name="is_featured">
                    <span>Featured Book</span>
                </label>
            </div>
        </div>
        
        <div class="form-actions" style="display: flex; gap: 15px;">
            <button type="submit" class="btn btn-primary">Save Book</button>
            <button type="button" class="btn btn-outline" onclick="hideAddBookForm()">Cancel</button>
        </div>
    </form>
</div>

<!-- Books Table -->
<div id="booksTableContainer" style="background: white; border-radius: 8px; overflow: hidden;">
    <div style="padding: 20px; text-align: center;">
        <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto;"></div>
        <p>Loading books...</p>
    </div>
</div>

<script>
    // Books management functionality
    let booksData = [];
    
    // Load books table
    async function loadBooksTable() {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const response = await fetch(`${API_BASE_URL}/books/get-books.php`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            const container = document.getElementById('booksTableContainer');
            
            if (data.success && data.books) {
                booksData = data.books;
                
                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table class="admin-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 15px; text-align: left;">ID</th>
                                    <th style="padding: 15px; text-align: left;">Book Details</th>
                                    <th style="padding: 15px; text-align: left;">Category</th>
                                    <th style="padding: 15px; text-align: left;">Price</th>
                                    <th style="padding: 15px; text-align: left;">Status</th>
                                    <th style="padding: 15px; text-align: left;">Added</th>
                                    <th style="padding: 15px; text-align: left;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.books.map(book => {
                                    return `
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 15px;">${book.id}</td>
                                            <td style="padding: 15px;">
                                                <div style="display: flex; align-items: center; gap: 15px;">
                                                    <div style="width: 60px; height: 80px; background: #f8f9fa; border-radius: 4px; overflow: hidden;">
                                                        ${book.image_url ? 
                                                            `<img src="${book.image_url}" alt="${book.title}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                                            `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #666;">
                                                                <i class="fas fa-book" style="font-size: 24px;"></i>
                                                            </div>`
                                                        }
                                                    </div>
                                                    <div>
                                                        <strong>${book.title}</strong><br>
                                                        <small style="color: #666;">by ${book.author}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td style="padding: 15px;">
                                                <span style="
                                                    padding: 4px 12px;
                                                    background: #E8F6F3;
                                                    color: #16A085;
                                                    border-radius: 20px;
                                                    font-size: 0.8rem;
                                                ">
                                                    ${book.category || 'General'}
                                                </span>
                                            </td>
                                            <td style="padding: 15px;">
                                                <strong style="color: #2ECC71;">$${parseFloat(book.price).toFixed(2)}</strong>
                                            </td>
                                            <td style="padding: 15px;">
                                                <span style="
                                                    padding: 4px 12px;
                                                    border-radius: 20px;
                                                    font-size: 0.8rem;
                                                    background: ${book.is_featured ? '#FEF9E720' : '#EAECEE'};
                                                    color: ${book.is_featured ? '#F39C12' : '#7F8C8D'};
                                                    border: 1px solid ${book.is_featured ? '#F39C12' : '#BDC3C7'};
                                                ">
                                                    ${book.is_featured ? 'Featured' : 'Regular'}
                                                </span>
                                            </td>
                                            <td style="padding: 15px;">
                                                ${formatDate(book.created_at)}
                                            </td>
                                            <td style="padding: 15px;">
                                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                    <button class="btn btn-sm" onclick="viewBook(${book.id})" style="padding: 5px 10px; font-size: 0.8rem;">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-sm" onclick="editBook(${book.id})" style="padding: 5px 10px; font-size: 0.8rem; background: #3498DB; color: white;">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm" onclick="toggleFeatured(${book.id})" style="padding: 5px 10px; font-size: 0.8rem; background: #F39C12; color: white;">
                                                        <i class="fas fa-star"></i>
                                                    </button>
                                                    <button class="btn btn-sm" onclick="deleteBook(${book.id})" style="padding: 5px 10px; font-size: 0.8rem; background: #E74C3C; color: white;">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="padding: 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #dee2e6;">
                        <div style="color: #666;">
                            Showing ${data.books.length} of ${data.total || data.books.length} books
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-outline" style="padding: 8px 15px;">Previous</button>
                            <button class="btn btn-primary" style="padding: 8px 15px;">Next</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #666;">
                        <i class="fas fa-book" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h3>No Books Found</h3>
                        <p>No books have been added to the collection yet.</p>
                        <button class="btn btn-primary" onclick="showAddBookForm()" style="margin-top: 15px;">
                            <i class="fas fa-book-medical"></i> Add First Book
                        </button>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error loading books table:', error);
            document.getElementById('booksTableContainer').innerHTML = `
                <div style="padding: 40px; text-align: center; color: #E74C3C;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <h3>Error Loading Books</h3>
                    <p>Failed to load books data. Please try again.</p>
                    <button class="btn btn-outline" onclick="loadBooksTable()" style="margin-top: 15px;">
                        <i class="fas fa-sync-alt"></i> Retry
                    </button>
                </div>
            `;
        }
    }
    
    // Show add book form
    function showAddBookForm() {
        document.getElementById('addBookForm').style.display = 'block';
    }
    
    // Hide add book form
    function hideAddBookForm() {
        document.getElementById('addBookForm').style.display = 'none';
        document.getElementById('bookForm').reset();
    }
    
    // Submit book form
    document.getElementById('bookForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        data.is_featured = data.is_featured === 'on';
        
        try {
            const token = localStorage.getItem('token');
            if (!token) throw new Error('Not authenticated');
            
            const response = await fetch(`${API_BASE_URL}/books/manage-books.php`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('Book added successfully!', 'success');
                hideAddBookForm();
                loadBooksTable();
            } else {
                showNotification(result.message || 'Failed to add book', 'error');
            }
            
        } catch (error) {
            console.error('Error adding book:', error);
            showNotification('Error adding book', 'error');
        }
    });
    
    // View book
    function viewBook(bookId) {
        // Show book details
        showNotification(`Viewing book #${bookId}`, 'info');
    }
    
    // Edit book
    function editBook(bookId) {
        // Show edit form with book data
        showNotification(`Editing book #${bookId}`, 'info');
    }
    
    // Toggle featured status
    function toggleFeatured(bookId) {
        showNotification(`Toggling featured status for book #${bookId}`, 'info');
        // In a real app, call API to update featured status
        setTimeout(() => {
            showNotification('Featured status updated', 'success');
            loadBooksTable();
        }, 1000);
    }
    
    // Delete book
    function deleteBook(bookId) {
        if (!confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
            return;
        }
        
        showNotification(`Deleting book #${bookId}...`, 'info');
        // In a real app, call delete API
        setTimeout(() => {
            showNotification(`Book #${bookId} deleted successfully`, 'success');
            loadBooksTable();
        }, 1500);
    }
    
    // Export books
    function exportBooks() {
        showNotification('Exporting books data...', 'info');
        // In a real app, generate CSV/Excel
        setTimeout(() => {
            showNotification('Books data exported successfully!', 'success');
        }, 1500);
    }
    
    // Refresh books
    function refreshBooks() {
        loadBooksTable();
        showNotification('Books list refreshed');
    }
    
    // Load books table when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadBooksTable();
    });
</script>