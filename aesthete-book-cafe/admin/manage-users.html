<div class="card-header">
    <h3>User Management</h3>
    <div>
        <button class="btn btn-outline" onclick="exportUsers()">
            <i class="fas fa-download"></i> Export
        </button>
        <button class="btn btn-primary" onclick="showAddUserModal()">
            <i class="fas fa-user-plus"></i> Add User
        </button>
    </div>
</div>

<div class="admin-alert success">
    <div>
        <i class="fas fa-info-circle"></i>
        <span>Manage all user accounts, permissions, and activities. Total: <strong id="totalUsersCount">0</strong> users</span>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-sm" onclick="refreshUsers()">
            <i class="fas fa-sync-alt"></i>
        </button>
        <button class="btn btn-sm" onclick="toggleUserFilter()">
            <i class="fas fa-filter"></i>
        </button>
    </div>
</div>

<!-- User Filters (Initially Hidden) -->
<div id="userFilters" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Role</label>
            <select id="filterRole" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Status</label>
            <select id="filterStatus" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">All Status</option>
                <option value="verified">Verified</option>
                <option value="unverified">Unverified</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Date Range</label>
            <select id="filterDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Search</label>
            <input type="text" id="searchUsers" placeholder="Search users..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
    </div>
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn btn-primary" onclick="applyUserFilters()">Apply Filters</button>
        <button class="btn btn-outline" onclick="resetUserFilters()">Reset</button>
    </div>
</div>

<!-- Users Table -->
<div id="usersTableContainer" style="background: white; border-radius: 8px; overflow: hidden;">
    <div style="padding: 40px; text-align: center;">
        <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto;"></div>
        <p>Loading users...</p>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal" id="addUserModal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div style="padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="margin: 0;">Add New User</h3>
                <button onclick="closeAddUserModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <form id="addUserForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" name="username" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" name="password" required minlength="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" name="confirm_password" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" name="full_name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" name="phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Role</label>
                        <select name="is_admin" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="0">User</option>
                            <option value="1">Administrator</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" name="send_welcome_email" checked>
                        <span>Send welcome email</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <input type="checkbox" name="email_verified" checked>
                        <span>Mark email as verified</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Create User</button>
                    <button type="button" class="btn btn-outline" onclick="closeAddUserModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal" id="editUserModal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div style="padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="margin: 0;">Edit User</h3>
                <button onclick="closeEditUserModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <form id="editUserForm">
                <input type="hidden" id="editUserId" name="id">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" id="editUsername" name="username" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="editEmail" name="email" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="editFullName" name="full_name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="editPhone" name="phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Role</label>
                        <select id="editIsAdmin" name="is_admin" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="0">User</option>
                            <option value="1">Administrator</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="editIsVerified" name="is_verified">
                        <span>Email verified</span>
                    </label>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h4>Change Password (Optional)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                        <div class="form-group">
                            <label>New Password</label>
                            <input type="password" name="new_password" minlength="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div class="form-group">
                            <label>Confirm Password</label>
                            <input type="password" name="confirm_new_password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Changes</button>
                    <button type="button" class="btn btn-outline" onclick="closeEditUserModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal" id="userDetailsModal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div style="padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="margin: 0;">User Details</h3>
                <button onclick="closeUserDetailsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <div id="userDetailsContent">
                <!-- Will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
    // Users management functionality
    let usersData = [];
    let currentFilters = {};
    
    // Load users table
    async function loadUsersTable(filters = {}) {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            // Build query string from filters
            const queryParams = new URLSearchParams();
            if (filters.role) queryParams.append('role', filters.role);
            if (filters.status) queryParams.append('status', filters.status);
            if (filters.date) queryParams.append('date', filters.date);
            if (filters.search) queryParams.append('search', filters.search);
            
            const url = `${API_BASE_URL}/admin/get-users.php?${queryParams.toString()}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            const container = document.getElementById('usersTableContainer');
            
            if (data.success && data.users) {
                usersData = data.users;
                
                // Update total count
                document.getElementById('totalUsersCount').textContent = data.total || data.users.length;
                
                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table class="admin-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6;">
                                        <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers(this.checked)">
                                    </th>
                                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6;">User</th>
                                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6;">Contact</th>
                                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6;">Role</th>
                                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6;">Status</th>
                                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6;">Joined</th>
                                    <th style="padding: 15px; text-align: left; border-bottom: 2px solid #dee2e6;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(user => `
                                    <tr style="border-bottom: 1px solid #dee2e6;">
                                        <td style="padding: 15px;">
                                            <input type="checkbox" class="user-checkbox" value="${user.id}">
                                        </td>
                                        <td style="padding: 15px;">
                                            <div style="display: flex; align-items: center; gap: 15px;">
                                                <div style="
                                                    width: 40px;
                                                    height: 40px;
                                                    border-radius: 50%;
                                                    background: ${user.is_admin ? '#3498DB' : '#2ECC71'};
                                                    color: white;
                                                    display: flex;
                                                    align-items: center;
                                                    justify-content: center;
                                                    font-weight: bold;
                                                    font-size: 1.1rem;
                                                ">
                                                    ${user.username.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600; color: #2C3E50;">${user.username}</div>
                                                    <div style="color: #666; font-size: 0.9rem;">ID: ${user.id}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td style="padding: 15px;">
                                            <div style="color: #2C3E50; font-weight: 500;">${user.email}</div>
                                            ${user.phone ? `<div style="color: #666; font-size: 0.9rem; margin-top: 5px;">${user.phone}</div>` : ''}
                                        </td>
                                        <td style="padding: 15px;">
                                            <span style="
                                                padding: 6px 12px;
                                                border-radius: 20px;
                                                font-size: 0.8rem;
                                                font-weight: 600;
                                                background: ${user.is_admin ? '#3498DB20' : '#2ECC7120'};
                                                color: ${user.is_admin ? '#3498DB' : '#2ECC71'};
                                                border: 1px solid ${user.is_admin ? '#3498DB' : '#2ECC71'};
                                            ">
                                                ${user.is_admin ? 'Admin' : 'User'}
                                            </span>
                                        </td>
                                        <td style="padding: 15px;">
                                            <span style="
                                                padding: 6px 12px;
                                                border-radius: 20px;
                                                font-size: 0.8rem;
                                                font-weight: 600;
                                                background: ${user.is_verified ? '#2ECC7120' : '#E74C3C20'};
                                                color: ${user.is_verified ? '#2ECC71' : '#E74C3C'};
                                                border: 1px solid ${user.is_verified ? '#2ECC71' : '#E74C3C'};
                                            ">
                                                ${user.is_verified ? 'Verified' : 'Unverified'}
                                            </span>
                                            ${user.is_admin ? '<div style="color: #F39C12; font-size: 0.8rem; margin-top: 5px;"><i class="fas fa-crown"></i> Admin</div>' : ''}
                                        </td>
                                        <td style="padding: 15px;">
                                            <div style="color: #2C3E50;">${formatDate(user.created_at)}</div>
                                            <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                                ${formatRelativeTime(user.created_at)}
                                            </div>
                                        </td>
                                        <td style="padding: 15px;">
                                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                <button class="btn btn-sm" onclick="viewUserDetails(${user.id})" style="padding: 6px 12px; background: #3498DB; color: white;">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm" onclick="editUser(${user.id})" style="padding: 6px 12px; background: #F39C12; color: white;">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                ${!user.is_admin ? `
                                                    <button class="btn btn-sm" onclick="toggleAdminStatus(${user.id}, ${user.is_admin})" style="padding: 6px 12px; background: #9B59B6; color: white;">
                                                        <i class="fas fa-user-shield"></i>
                                                    </button>
                                                ` : ''}
                                                <button class="btn btn-sm" onclick="deleteUser(${user.id})" style="padding: 6px 12px; background: #E74C3C; color: white;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="
                        padding: 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-top: 1px solid #dee2e6;
                        background: #f8f9fa;
                    ">
                        <div style="display: flex; gap: 15px;">
                            <select id="bulkAction" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Bulk Actions</option>
                                <option value="delete">Delete Selected</option>
                                <option value="verify">Verify Email</option>
                                <option value="make_admin">Make Admin</option>
                                <option value="remove_admin">Remove Admin</option>
                            </select>
                            <button class="btn btn-primary" onclick="applyBulkAction()">Apply</button>
                        </div>
                        
                        <div style="color: #666;">
                            Showing ${data.users.length} of ${data.total || data.users.length} users
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-outline" style="padding: 8px 15px;">Previous</button>
                            <button class="btn btn-primary" style="padding: 8px 15px;">Next</button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center; color: #666;">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h3>No Users Found</h3>
                        <p>No user accounts have been created yet.</p>
                        <button class="btn btn-primary" onclick="showAddUserModal()" style="margin-top: 15px;">
                            <i class="fas fa-user-plus"></i> Add First User
                        </button>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error loading users table:', error);
            document.getElementById('usersTableContainer').innerHTML = `
                <div style="padding: 60px; text-align: center; color: #E74C3C;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                    <h3>Error Loading Users</h3>
                    <p>Failed to load user data. Please try again.</p>
                    <button class="btn btn-outline" onclick="loadUsersTable()" style="margin-top: 15px;">
                        <i class="fas fa-sync-alt"></i> Retry
                    </button>
                </div>
            `;
        }
    }
    
    // Toggle select all users
    function toggleSelectAllUsers(checked) {
        const checkboxes = document.querySelectorAll('.user-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
    }
    
    // Get selected user IDs
    function getSelectedUserIds() {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }
    
    // Apply bulk action
    async function applyBulkAction() {
        const action = document.getElementById('bulkAction').value;
        const userIds = getSelectedUserIds();
        
        if (userIds.length === 0) {
            showNotification('Please select users first', 'error');
            return;
        }
        
        if (!action) {
            showNotification('Please select an action', 'error');
            return;
        }
        
        let confirmMessage = '';
        switch(action) {
            case 'delete':
                confirmMessage = `Are you sure you want to delete ${userIds.length} user(s)?`;
                break;
            case 'verify':
                confirmMessage = `Verify email for ${userIds.length} user(s)?`;
                break;
            case 'make_admin':
                confirmMessage = `Make ${userIds.length} user(s) administrators?`;
                break;
            case 'remove_admin':
                confirmMessage = `Remove admin privileges from ${userIds.length} user(s)?`;
                break;
        }
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const response = await fetch(`${API_BASE_URL}/admin/bulk-users.php`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    action: action,
                    user_ids: userIds
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(data.message, 'success');
                loadUsersTable(currentFilters);
            } else {
                showNotification(data.message, 'error');
            }
            
        } catch (error) {
            console.error('Error applying bulk action:', error);
            showNotification('Error applying bulk action', 'error');
        }
    }
    
    // Show add user modal
    function showAddUserModal() {
        document.getElementById('addUserModal').style.display = 'block';
    }
    
    // Close add user modal
    function closeAddUserModal() {
        document.getElementById('addUserModal').style.display = 'none';
        document.getElementById('addUserForm').reset();
    }
    
    // Submit add user form
    document.getElementById('addUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        // Validation
        if (data.password !== data.confirm_password) {
            showNotification('Passwords do not match', 'error');
            return;
        }
        
        if (data.password.length < 6) {
            showNotification('Password must be at least 6 characters', 'error');
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            // Prepare data for API
            const userData = {
                username: data.username,
                email: data.email,
                password: data.password,
                full_name: data.full_name,
                phone: data.phone,
                is_admin: parseInt(data.is_admin),
                email_verified: data.email_verified === 'on',
                send_welcome_email: data.send_welcome_email === 'on'
            };
            
            const response = await fetch(`${API_BASE_URL}/admin/create-user.php`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(userData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('User created successfully', 'success');
                closeAddUserModal();
                loadUsersTable(currentFilters);
            } else {
                showNotification(result.message, 'error');
            }
            
        } catch (error) {
            console.error('Error creating user:', error);
            showNotification('Error creating user', 'error');
        }
    });
    
    // Edit user
    async function editUser(userId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const response = await fetch(`${API_BASE_URL}/admin/get-user.php?id=${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            
            if (data.success && data.user) {
                const user = data.user;
                
                // Populate form
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editEmail').value = user.email;
                document.getElementById('editFullName').value = user.full_name || '';
                document.getElementById('editPhone').value = user.phone || '';
                document.getElementById('editIsAdmin').value = user.is_admin ? '1' : '0';
                document.getElementById('editIsVerified').checked = user.is_verified;
                
                // Show modal
                document.getElementById('editUserModal').style.display = 'block';
            }
            
        } catch (error) {
            console.error('Error loading user data:', error);
            showNotification('Error loading user data', 'error');
        }
    }
    
    // Close edit user modal
    function closeEditUserModal() {
        document.getElementById('editUserModal').style.display = 'none';
        document.getElementById('editUserForm').reset();
    }
    
    // Submit edit user form
    document.getElementById('editUserForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        
        // Check if password is being changed
        if (data.new_password && data.new_password !== data.confirm_new_password) {
            showNotification('New passwords do not match', 'error');
            return;
        }
        
        if (data.new_password && data.new_password.length < 6) {
            showNotification('New password must be at least 6 characters', 'error');
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            // Prepare update data
            const updateData = {
                id: parseInt(data.id),
                username: data.username,
                email: data.email,
                full_name: data.full_name,
                phone: data.phone,
                is_admin: parseInt(data.is_admin),
                is_verified: data.is_verified === 'on'
            };
            
            // Add password if provided
            if (data.new_password) {
                updateData.password = data.new_password;
            }
            
            const response = await fetch(`${API_BASE_URL}/admin/update-user.php`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(updateData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('User updated successfully', 'success');
                closeEditUserModal();
                loadUsersTable(currentFilters);
            } else {
                showNotification(result.message, 'error');
            }
            
        } catch (error) {
            console.error('Error updating user:', error);
            showNotification('Error updating user', 'error');
        }
    });
    
    // View user details
    async function viewUserDetails(userId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const response = await fetch(`${API_BASE_URL}/admin/get-user-details.php?id=${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const data = await response.json();
            const container = document.getElementById('userDetailsContent');
            
            if (data.success && data.user) {
                const user = data.user;
                const stats = data.stats || {};
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 100px 1fr; gap: 30px; margin-bottom: 30px;">
                        <div>
                            <div style="
                                width: 100px;
                                height: 100px;
                                border-radius: 50%;
                                background: ${user.is_admin ? '#3498DB' : '#2ECC71'};
                                color: white;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 2rem;
                                font-weight: bold;
                            ">
                                ${user.username.charAt(0).toUpperCase()}
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 10px 0; color: #2C3E50;">${user.username}</h4>
                            <div style="color: #666; margin-bottom: 5px;">
                                <i class="fas fa-envelope"></i> ${user.email}
                            </div>
                            ${user.phone ? `
                                <div style="color: #666; margin-bottom: 5px;">
                                    <i class="fas fa-phone"></i> ${user.phone}
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <span style="
                                    padding: 6px 12px;
                                    border-radius: 20px;
                                    font-size: 0.8rem;
                                    background: ${user.is_admin ? '#3498DB20' : '#2ECC7120'};
                                    color: ${user.is_admin ? '#3498DB' : '#2ECC71'};
                                ">
                                    ${user.is_admin ? 'Administrator' : 'User'}
                                </span>
                                <span style="
                                    padding: 6px 12px;
                                    border-radius: 20px;
                                    font-size: 0.8rem;
                                    background: ${user.is_verified ? '#2ECC7120' : '#E74C3C20'};
                                    color: ${user.is_verified ? '#2ECC71' : '#E74C3C'};
                                ">
                                    ${user.is_verified ? 'Verified' : 'Unverified'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                        gap: 20px;
                        margin-bottom: 30px;
                    ">
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #3498DB;">${stats.events_registered || 0}</div>
                            <div style="color: #666; font-size: 0.9rem;">Events Registered</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #2ECC71;">${stats.messages_sent || 0}</div>
                            <div style="color: #666; font-size: 0.9rem;">Messages Sent</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.8rem; font-weight: bold; color: #9B59B6;">${stats.orders_placed || 0}</div>
                            <div style="color: #666; font-size: 0.9rem;">Orders Placed</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="margin-bottom: 15px;">Account Information</h4>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-weight: 500; color: #666; font-size: 0.9rem;">Member Since</div>
                                    <div style="color: #2C3E50;">${formatDate(user.created_at)}</div>
                                </div>
                                <div>
                                    <div style="font-weight: 500; color: #666; font-size: 0.9rem;">Last Login</div>
                                    <div style="color: #2C3E50;">${user.last_login ? formatRelativeTime(user.last_login) : 'Never'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px;">
                        <button class="btn btn-primary" onclick="editUser(${user.id})">
                            <i class="fas fa-edit"></i> Edit User
                        </button>
                        <button class="btn btn-outline" onclick="sendResetPassword(${user.id})">
                            <i class="fas fa-key"></i> Reset Password
                        </button>
                        ${!user.is_admin ? `
                            <button class="btn btn-outline" onclick="toggleAdminStatus(${user.id}, ${user.is_admin})">
                                <i class="fas fa-user-shield"></i> ${user.is_admin ? 'Remove Admin' : 'Make Admin'}
                            </button>
                        ` : ''}
                    </div>
                `;
                
                // Show modal
                document.getElementById('userDetailsModal').style.display = 'block';
            }
            
        } catch (error) {
            console.error('Error loading user details:', error);
            showNotification('Error loading user details', 'error');
        }
    }
    
    // Close user details modal
    function closeUserDetailsModal() {
        document.getElementById('userDetailsModal').style.display = 'none';
    }
    
    // Toggle admin status
    async function toggleAdminStatus(userId, currentStatus) {
        const action = currentStatus ? 'remove_admin' : 'make_admin';
        const confirmMsg = currentStatus 
            ? 'Remove admin privileges from this user?'
            : 'Make this user an administrator?';
        
        if (!confirm(confirmMsg)) return;
        
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const response = await fetch(`${API_BASE_URL}/admin/update-user.php`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    id: userId,
                    is_admin: !currentStatus
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(data.message, 'success');
                loadUsersTable(currentFilters);
                closeUserDetailsModal();
            } else {
                showNotification(data.message, 'error');
            }
            
        } catch (error) {
            console.error('Error toggling admin status:', error);
            showNotification('Error updating user role', 'error');
        }
    }
    
    // Delete user
    async function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const response = await fetch(`${API_BASE_URL}/admin/delete-user.php`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id: userId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('User deleted successfully', 'success');
                loadUsersTable(currentFilters);
                closeUserDetailsModal();
            } else {
                showNotification(data.message, 'error');
            }
            
        } catch (error) {
            console.error('Error deleting user:', error);
            showNotification('Error deleting user', 'error');
        }
    }
    
    // Send reset password
    async function sendResetPassword(userId) {
        if (!confirm('Send password reset email to this user?')) return;
        
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const response = await fetch(`${API_BASE_URL}/admin/reset-user-password.php`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ user_id: userId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Password reset email sent', 'success');
            } else {
                showNotification(data.message, 'error');
            }
            
        } catch (error) {
            console.error('Error sending reset password:', error);
            showNotification('Error sending reset password', 'error');
        }
    }
    
    // Toggle user filter panel
    function toggleUserFilter() {
        const filters = document.getElementById('userFilters');
        filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
    }
    
    // Apply user filters
    function applyUserFilters() {
        currentFilters = {
            role: document.getElementById('filterRole').value,
            status: document.getElementById('filterStatus').value,
            date: document.getElementById('filterDate').value,
            search: document.getElementById('searchUsers').value.trim()
        };
        
        loadUsersTable(currentFilters);
    }
    
    // Reset user filters
    function resetUserFilters() {
        document.getElementById('filterRole').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterDate').value = '';
        document.getElementById('searchUsers').value = '';
        currentFilters = {};
        loadUsersTable();
    }
    
    // Export users
    function exportUsers() {
        showNotification('Exporting users data...', 'info');
        // In a real app, generate CSV/Excel
        setTimeout(() => {
            showNotification('Users data exported successfully!', 'success');
        }, 1500);
    }
    
    // Refresh users
    function refreshUsers() {
        loadUsersTable(currentFilters);
        showNotification('Users list refreshed');
    }
    
    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
    
    // Load users table when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadUsersTable();
    });
</script>

<style>
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    
    .modal-content {
        background: white;
        border-radius: 12px;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlideUp 0.3s ease;
    }
    
    @keyframes modalSlideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>